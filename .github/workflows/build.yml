name: SonarCloud Analysis (runner-runner scanner, Java 17)

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  sonarcloud-runner:
    name: SonarCloud scan (with local SonarScanner CLI + Java 17)
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '17'
      
      - name: Install unzip (if missing)
        run: |
          sudo apt-get update
          sudo apt-get install -y unzip curl

      - name: Download SonarScanner CLI
        env:
          SONAR_SCANNER_VERSION: "4.8.1.3023"  # change if needed
        run: |
          # download the SonarScanner CLI zip from SonarSource official binaries
          SC_VERSION="$SONAR_SCANNER_VERSION"
          SC_ZIP="sonar-scanner-cli-${SC_VERSION}-linux.zip"
          SC_URL="https://binaries.sonarsource.com/Distribution/sonar-scanner-cli/${SC_ZIP}"

          echo "Downloading SonarScanner CLI ${SC_VERSION}..."
          curl -sSLo "$SC_ZIP" "$SC_URL"
          unzip -q "$SC_ZIP"
          rm -f "$SC_ZIP"
          # move to a known folder
          mv "sonar-scanner-${SC_VERSION}-linux" sonar-scanner

      - name: Export sonar scanner to PATH
        run: |
          echo "::add-path::${{ github.workspace }}/sonar-scanner/bin"
        # For newer runners, use GITHUB_PATH instead of add-path (safe):
        # run: echo "${{ github.workspace }}/sonar-scanner/bin" >> $GITHUB_PATH

      - name: Show java & scanner versions
        run: |
          java -version
          ./sonar-scanner/bin/sonar-scanner -v || true

      - name: Run SonarScanner
        env:
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ensure project base dir points to your Unity project
          # sonar.projectBaseDir can also live in sonar-project.properties
          ./sonar-scanner/bin/sonar-scanner \
            -Dsonar.projectBaseDir=CodeBase \
            -Dsonar.login="${SONAR_TOKEN}" \
            -Dsonar.host.url=https://sonarcloud.io

name: Unity + SonarCloud

on:
  push:
    branches: [ "main" ]
  pull_request:
    branches: [ "main" ]

jobs:
  build:
    runs-on: windows-latest

    env:
      UNITY_VERSION: "6000.0.62f1"  # <-- CHANGE Unity version
      PROJECT_PATH: "CodeBase"     # <-- Your Unity folder
      SONAR_PROJECT_KEY: "djedje-cyber_UltraInstinctVR"
      SONAR_ORG: "djedje-cyber"
      SONAR_HOST: "https://sonarcloud.io"

    steps:
    - name: Checkout repository
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    # ✅ Install .NET (needed for Sonar scanner)
    - name: Setup .NET
      uses: actions/setup-dotnet@v3
      with:
        dotnet-version: "7.0.x"

    # ✅ Begin SonarCloud scan
    - name: SonarCloud - Begin
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet tool install --global dotnet-sonarscanner
        dotnet sonarscanner begin `
          /k:"$env:SONAR_PROJECT_KEY" `
          /o:"$env:SONAR_ORG" `
          /d:sonar.host.url="$env:SONAR_HOST" `
          /d:sonar.token="$env:SONAR_TOKEN" `
          /d:sonar.projectBaseDir="$env:PROJECT_PATH" `
          /d:sonar.sources="$env:PROJECT_PATH/Assets" `
          /d:sonar.cs.unity.projectPath="$env:PROJECT_PATH" `
          /d:sonar.exclusions="**/Library/**,**/Temp/**,**/Build/**,**/Builds/**,**/Logs/**"

    # ✅ Build Unity Scripts (batchmode)
    - name: Unity Build (script compile only)
      run: |
        "C:\Program Files\Unity\Hub\Editor\$env:UNITY_VERSION\Editor\Unity.exe" `
        -batchmode -quit `
        -projectPath "$env:PROJECT_PATH" `
        -buildTarget StandaloneWindows64 `
        -logFile -

    # ✅ End SonarCloud scan
    - name: SonarCloud - End
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      run: |
        dotnet sonarscanner end /d:sonar.token="$env:SONAR_TOKEN"

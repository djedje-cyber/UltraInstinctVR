name: Unity CI + SonarCloud

on:
  push:
    branches: [ main ]
  pull_request:

jobs:
  unity-build:
    runs-on: windows-latest
    env:
      UNITY_VERSION: 6000.0.62f1
      PROJECT_PATH: CodeBase

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      # Install Unity via GitHub Action
      - name: Install Unity
        uses: game-ci/unity-builder@v2
        with:
          unityVersion: ${{ env.UNITY_VERSION }}
          # optionally, add modules like Windows build support if needed
          modules: Windows-Mono

      # Compile scripts / run Unity in batch mode
      - name: Unity Compile Scripts
        shell: pwsh
        run: |
          $unityExe = "C:\Program Files\Unity\Hub\Editor\$env:UNITY_VERSION\Editor\Unity.exe"
          & $unityExe `
            -batchmode `
            -quit `
            -projectPath "$env:PROJECT_PATH" `
            -buildTarget StandaloneWindows64 `
            -logFile -

      # SonarCloud analysis for C# projects
      - name: SonarCloud Begin Analysis
        uses: SonarSource/sonarcloud-github-action@v2
        with:
          projectKey: djedje-cyber_UltraInstinctVR
          organization: djedje-cyber
          scannerMode: 'MSBuild'
          extraProperties: |
            sonar.exclusions=Library/**,Temp/**,Build/**,Builds/**
            sonar.cs.opencover.reportsPaths=**/coverage.opencover.xml

      # Build your Unity project for SonarCloud analysis
      - name: Build Unity Project (MSBuild)
        shell: pwsh
        run: |
          # Path to your compiled solution (.sln)
          $solutionPath = "$env:PROJECT_PATH\UltraInstinctVR.sln"
          dotnet build $solutionPath /p:Configuration=Release

      # End SonarCloud analysis
      - name: SonarCloud End Analysis
        run: dotnet sonarscanner end /d:sonar.login="${{ secrets.SONAR_TOKEN }}"
